name: Compare Branches

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'List of repositories to check (comma-separated)'
        required: true
        default: 'https://github.com/aakashdinkarh/portfolio-v1.git,https://github.com/aakashdinkarh/panda-img.git'

jobs:
  compare-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch differences
        run: |
          # Function to compare branches
          compare_branches() {
            local repo=$1
            echo "Checking repository: $repo"
            
            # Clone the repository
            if ! git clone --quiet $repo temp_repo 2>/dev/null; then
              echo "‚ùå Failed to clone repository: $repo"
              return 1
            fi
            cd temp_repo || return 1
            
            # Fetch all branches
            if ! git fetch --quiet origin 2>/dev/null; then
              echo "‚ùå Failed to fetch branches for: $repo"
              cd ..
              rm -rf temp_repo
              return 1
            fi
            
            # Check if remote-build branch exists
            if git show-ref --verify --quiet refs/remotes/origin/remote-build; then
              # Compare the branches directly
              DIFF_COUNT=$(git rev-list --count master...remote-build 2>/dev/null)
              
              if [ "$DIFF_COUNT" != "0" ]; then
                echo "‚ö†Ô∏è Changes found between master and remote-build in $repo"
                echo "$repo" >> $GITHUB_WORKSPACE/needs_update.txt
              else
                echo "‚úÖ No changes to compare in $repo"
              fi
            else
              echo "‚ùå remote-build branch not found in $repo"
            fi
            
            cd ..
            rm -rf temp_repo
          }
          
          # Create workspace directory if it doesn't exist
          mkdir -p $GITHUB_WORKSPACE
          
          # Convert comma-separated input to array
          IFS=',' read -ra REPOS <<< "${{ github.event.inputs.repositories }}"
          
          # Check each repository
          for repo in "${REPOS[@]}"; do
            compare_branches "$repo"
            echo "-----------------------------------"
          done
          
          # Show summary of repositories needing updates
          if [ -f "$GITHUB_WORKSPACE/needs_update.txt" ]; then
            echo "üìã Summary of repositories needing updates:"
            cat "$GITHUB_WORKSPACE/needs_update.txt"
          else
            echo "‚úÖ All repositories are in sync!"
          fi
