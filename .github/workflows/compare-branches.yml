name: Compare Branches

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'List of repositories to check (comma-separated)'
        required: true
        default: 'https://github.com/aakashdinkarh/portfolio-v1.git,https://github.com/aakashdinkarh/panda-img.git'

jobs:
  compare-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch differences
        run: |
          # Function to compare branches
          compare_branches() {
            local repo=$1
            echo "Checking repository: $repo"
            
            # Clone the repository
            if ! git clone --quiet $repo temp_repo 2>/dev/null; then
              echo "‚ùå Failed to clone repository: $repo"
              return 1
            fi
            cd temp_repo || return 1
            
            # Fetch all branches
            if ! git fetch --quiet origin 2>/dev/null; then
              echo "‚ùå Failed to fetch branches for: $repo"
              cd ..
              rm -rf temp_repo
              return 1
            fi
            
            # Check if remote-build branch exists
            if git show-ref --verify --quiet refs/remotes/origin/remote-build; then
              # Get latest commit hashes
              MASTER_HASH=$(git rev-parse origin/master 2>/dev/null)
              REMOTE_BUILD_HASH=$(git rev-parse origin/remote-build 2>/dev/null)
              
              if [ -z "$MASTER_HASH" ] || [ -z "$REMOTE_BUILD_HASH" ]; then
                echo "‚ùå Failed to get commit hashes for: $repo"
                cd ..
                rm -rf temp_repo
                return 1
              fi
              
              # Compare the branches
              if git merge-base --is-ancestor $REMOTE_BUILD_HASH $MASTER_HASH 2>/dev/null; then
                if [ "$MASTER_HASH" != "$REMOTE_BUILD_HASH" ]; then
                  echo "‚ö†Ô∏è WARNING: master is ahead of remote-build in $repo"
                  echo "$repo" >> $GITHUB_WORKSPACE/needs_update.txt
                else
                  echo "‚úÖ Branches are in sync for $repo"
                fi
              else
                echo "‚ö†Ô∏è WARNING: Branches have diverged in $repo"
                echo "$repo" >> $GITHUB_WORKSPACE/needs_update.txt
              fi
            else
              echo "‚ùå remote-build branch not found in $repo"
            fi
            
            cd ..
            rm -rf temp_repo
          }
          
          # Create workspace directory if it doesn't exist
          mkdir -p $GITHUB_WORKSPACE
          
          # Convert comma-separated input to array
          IFS=',' read -ra REPOS <<< "${{ github.event.inputs.repositories }}"
          
          # Check each repository
          for repo in "${REPOS[@]}"; do
            compare_branches "$repo"
            echo "-----------------------------------"
          done
          
          # Show summary of repositories needing updates
          if [ -f "$GITHUB_WORKSPACE/needs_update.txt" ]; then
            echo "üìã Summary of repositories needing updates:"
            cat "$GITHUB_WORKSPACE/needs_update.txt"
          else
            echo "‚úÖ All repositories are in sync!"
          fi
